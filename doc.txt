.com/scion-time/net/ntske"


CONSTANTS

const (
        RecEom       uint16 = 0
        RecNextproto uint16 = 1
        RecError     uint16 = 2
        RecWarning   uint16 = 3
        RecAead      uint16 = 4
        RecCookie    uint16 = 5
        RecServer    uint16 = 6
        RecPort      uint16 = 7
)
    NTS-KE record types

const (
        AES_SIV_CMAC_256 = 0x0f

        ServerPortIP    = 4460
        ServerPortSCION = 14460
)
const (
        ErrorCodeUnrecognizedCritical = 0
        ErrorCodeBadRequest           = 1
        ErrorCodeInternalServer       = 2
)
const NTPv4 uint16 = 0

FUNCTIONS

func AcceptQUICConn(ctx context.Context, l quic.Listener) (quic.Connection, error)
    AcceptQUICConn accepts an incoming QUIC connection from the quic.Listener.

func AcceptTLSConn(l net.Listener) (*tls.Conn, error)
    AcceptTLSConn accepts an incoming TLS connection from the net.Listener.

func ExportKeys(cs tls.ConnectionState, data *Data) error
    ExportKeys exports two extra sessions keys from the already established
    NTS-KE connection for use with NTS.

func ReadData(log *zap.Logger, reader *bufio.Reader, data *Data) error

TYPES

type Algorithm struct {
        RecordHdr
        Algo []uint16
}
    Algorithm is the record type for a list of AEAD algorithm we can use.

type Cookie struct {
        RecordHdr
        Cookie []byte
}
    Cookie is an NTS cookie to be used when querying time over NTS.

type CookieArrayMarshaler struct {
        Cookies [][]byte
}

func (m CookieArrayMarshaler) MarshalLogArray(enc zapcore.ArrayEncoder) error

type Data struct {
        C2sKey []byte
        S2cKey []byte
        Server string
        Port   uint16
        Cookie [][]byte
        Algo   uint16
}
    Data is the negotiated data from the NTS Key Exchange

type EncryptedServerCookie struct {
        ID         uint16
        Nonce      []byte
        Ciphertext []byte
}
    EncryptedServerCookie is the representation of an encrypted NTS cookie.

func (c *EncryptedServerCookie) Decode(b []byte) error
    Decode decodes an EncryptedServerCookie from a byte slice or returns an
    error if it can not decode.

func (c *EncryptedServerCookie) Decrypt(key []byte) (ServerCookie, error)
    Decrypt decrypts the EncryptedServerCookie using the provided key and
    returns a ServerCookie.

func (c *EncryptedServerCookie) Encode() []byte
    Encode encodes the EncryptedServerCookie to a byte slice.

type End struct {
        RecordHdr
}
    End is the End of Message record.

type Error struct {
        RecordHdr
        Code uint16
}
    Error is the record type to send errors to the other end. Put error code in
    Code.

type ExchangeMsg struct {
        Record []Record
}
    ExchangeMsg is a representation of a series of records to be sent to the
    peer.

func (m *ExchangeMsg) AddRecord(rec Record)
    AddRecord adds new record type to a Key Exchange message.

func (m ExchangeMsg) Pack() (buf *bytes.Buffer, err error)
    Pack allocates a buffer and packs all records into wire format in that
    buffer.

type Fetcher struct {
        Log       *zap.Logger
        TLSConfig tls.Config
        Port      string
        QUIC      struct {
                Enabled    bool
                DaemonAddr string
                LocalAddr  udp.UDPAddr
                RemoteAddr udp.UDPAddr
        }
        // Has unexported fields.
}
    Fetcher is a client side NTS Cookie fetcher. It can be used for both TCP/TLS
    and SCION QUIC connections.

func (f *Fetcher) FetchData() (Data, error)
    FetchData returns either cached Data or requests new Data by performing a
    NTSKE.

func (f *Fetcher) StoreCookie(cookie []byte)
    StoreCookie stores a cookie byte slice and appends it to the cached Data.

type Key struct {
        ID       int
        Value    []byte
        Validity struct {
                NotBefore time.Time
                NotAfter  time.Time
        }
}
    Key is the key shared between NTP and NTSKE server with a validity time
    period.

func (k *Key) IsValidAt(t time.Time) bool
    IsValidAt returns if the key is still valid.

type NextProto struct {
        RecordHdr
        NextProto uint16
}
    NextProto record. Tells the other side we want to speak NTP, probably.
    Set to 0.

type Port struct {
        RecordHdr
        Port     uint16
        Critical bool
}
    Port is the NTP Port record, telling the client to use this port for the
    next protocol query. Critical bit is optional. Set Critical to true if you
    want it set.

type Provider struct {
        // Has unexported fields.
}
    Provider is a thread safe provider for keys shared between NTP and NTSKE
    servers.

func NewProvider() *Provider
    NewProvider creates and returns a new provider.

func (p *Provider) Current() Key
    Current returns the newest Key or creates a new one if no one is valid.

func (p *Provider) Get(id int) (Key, bool)
    Get returns the Key with ID id and true if it exists and is still valid or
    false otherwise.

type Record interface {
        // Has unexported methods.
}
    Record is the interface all record types must implement. pack() packs the
    record into wire format.

type RecordHdr struct {
        Type    uint16 // First bit is Critical bit
        BodyLen uint16
}
    RecordHdr is the header on all records send in NTS-KE.

func (h RecordHdr) Header() RecordHdr

type Server struct {
        RecordHdr
        Addr     []byte
        Critical bool
}
    Server is the NTP Server record, telling the client to use a certain server
    for the next protocol query. Critical bit is optional. Set Critical to true
    if you want it set.

type ServerCookie struct {
        Algo uint16
        S2C  []byte
        C2S  []byte
}
    ServerCookie is the representation of a plaintext NTS cookie.

func (c *ServerCookie) Decode(b []byte) error
    Decode decodes a ServerCookie from a byte slice or returns an error if it
    can not decode.

func (c *ServerCookie) Encode() []byte
    Encode encodes the ServerCookie to a byte slice with following format for
    each field. uint16 | uint16 | []byte type | length | value

func (c *ServerCookie) EncryptWithNonce(key []byte, keyid int) (EncryptedServerCookie, error)
    EncryptWithNonce encrypts the ServerCookie using the provided key with a
    fresh nonce and returns an EncryptedServerCookie.

type Warning struct {
        RecordHdr
        Code uint16
}
    Warning is the record type to send warnings to the other end. Put warning
    code in Code.

aaron@aaron-VirtualBox:~/scion-time$ 


aaron@aaron-VirtualBox:~/scion-time$ go doc -all nts
package nts // import "example.com/scion-time/net/nts"


CONSTANTS

const (
        MaxPacketLen = 1024
)

FUNCTIONS

func DecodePacket(pkt *Packet, b []byte) (err error)
    DecodePacket decodes a byte slice to Packet. Authentication is not checkt
    here, but an error is thrown if it does not contain an Autheticator or
    UniqueID extension field.

func EncodePacket(b *[]byte, pkt *Packet)
    EncodePacket encodes Packet to a byte slice. It is expected that the first
    48 bytes of the slice already contain a NTP packet. NTS authentication is
    added here.

func ProcessRequest(b []byte, key []byte, pkt *Packet) error
    ProcessResponse handles the request from a client. It checks the
    authentication.

func ProcessResponse(b []byte, key []byte, ntskeFetcher *ntske.Fetcher, pkt *Packet, reqID []byte) error
    ProcessResponse handles the response from a server. It checks that the
    UniqueID matches the one from the request and checks the authentication.
    Additionally it stores the cookies.


TYPES

type Authenticator struct {
        Nonce      []byte
        CipherText []byte
        Key        []byte
        PlainText  []byte
        // Has unexported fields.
}
    An Authenticator is the NTS extension field for a NTS authenticator.
    It contains a nonce and authenticates the Packet using the Key. Additionally
    it can encrypt the contents of PlainText. pos is the position of the
    Authenticator in the NTP packet byte slice.

type Cookie struct {
        Cookie []byte
        // Has unexported fields.
}
    A Cookie is the NTS extension field for a NTS cookie. It contains a byte
    slice that only the server can decode to access the shared keys.

type CookiePlaceholder struct {
        Cookie []byte
        // Has unexported fields.
}
    A CookiePlaceholder is the NTS extension field for a NTS cookie placeholder.
    It contains a byte slice the same length as for a Cookie. The content
    however is will be ignored and should be 0.

type Packet struct {
        UniqueID           UniqueIdentifier
        Cookies            []Cookie
        CookiePlaceholders []CookiePlaceholder
        Auth               Authenticator
}
    A Packet contains the NTP extension fiels for a NTS secured NTP request.

func NewRequestPacket(ntskeData ntske.Data) (pkt Packet, uniqueid []byte)
    NewRequestPacket returns a new Packet initialized with a new UniqueID and a
    Cookie from ntskeData.

func NewResponsePacket(cookies [][]byte, key []byte, uniqueid []byte) (pkt Packet)
    NewResponsePacket creates and returns a new Packet that should be used by a
    server for a response to a request.

func (pkt *Packet) GetFirstCookie() ([]byte, error)
    GetFirstCookie returns the first cookie byte slice a packet contains.

type UniqueIdentifier struct {
        ID []byte
        // Has unexported fields.
}
    A UniqueIdentifier is the NTS extension that contains a nonce to uniquely
    identify a request.


